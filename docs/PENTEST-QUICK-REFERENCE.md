# Penetration Testing Quick Reference

Quick reference guide for testing NKP Kubernetes cluster security.

## ğŸš¨ Critical Tests (Run First)

### 1. Check for Privileged Containers
```bash
kubectl get pods --all-namespaces -o json | \
  jq '.items[] | select(.spec.containers[]?.securityContext.privileged == true) |
    "\(.metadata.namespace)/\(.metadata.name)"'
```

### 2. Find Cluster-Admin Bindings
```bash
kubectl get clusterrolebindings -o json | \
  jq '.items[] | select(.roleRef.name == "cluster-admin") | .metadata.name'
```

### 3. Extract Nutanix Credentials
```bash
# Prism Central credentials
kubectl get secrets --all-namespaces | grep -iE "prism|pc-credentials"

# CCM credentials
kubectl get secrets -n kube-system | grep nutanix-ccm

# CSI credentials
kubectl get secrets -n ntnx-system | grep csi
```

### 4. Test Service Account Permissions
```bash
# Test default service account
kubectl auth can-i create pods --as=system:serviceaccount:default:default -n kube-system

# Test Kommander service account
kubectl auth can-i get secrets --all-namespaces \
  --as=system:serviceaccount:kommander:kommander-kubeaddons-controller-manager
```

### 5. Find Exposed Services
```bash
# LoadBalancer services
kubectl get services --all-namespaces | grep LoadBalancer

# NodePort services
kubectl get services --all-namespaces | grep NodePort
```

---

## ğŸ› ï¸ Essential Free Tools

### Quick Install Commands

```bash
# Kubescape (Kubernetes security scanner)
curl -s https://raw.githubusercontent.com/kubescape/kubescape/master/install.sh | /bin/bash

# Kubeaudit (Security audit)
go install github.com/Shopify/kubeaudit@latest

# Kube-hunter (Security hunter)
pip install kube-hunter

# Trivy (Vulnerability scanner)
brew install trivy  # macOS
# or download from: https://github.com/aquasecurity/trivy/releases

# Kube-bench (CIS Benchmark)
curl -L https://github.com/aquasecurity/kube-bench/releases/download/v0.6.9/kube-bench_0.6.9_linux_amd64.tar.gz -o kube-bench.tar.gz
tar -xvf kube-bench.tar.gz
```

### Quick Scan Commands

```bash
# Kubescape - Full scan
kubescape scan framework nsa --exclude-namespaces kube-system,kube-public

# Kubescape - CVE scan
kubescape scan cve --exclude-namespaces kube-system,kube-public

# Kubeaudit - All checks
kubeaudit all

# Kube-hunter - Active scan
kube-hunter --remote <api-server-ip>

# Trivy - Cluster scan
trivy k8s cluster --severity HIGH,CRITICAL

# Kube-bench - Master node
./kube-bench master

# Kube-bench - Worker node
./kube-bench node
```

---

## ğŸ¯ Nutanix Component Tests

### Kommander
```bash
# Check Kommander pods
kubectl get pods -n kommander

# Check Kommander secrets
kubectl get secrets -n kommander

# Test Kommander API access
kubectl port-forward -n kommander svc/kommander-kubeaddons-controller-manager 8080:443
curl -k https://localhost:8080/api/v1/workspaces
```

### CAPX (Nutanix Cluster API)
```bash
# Check CAPX pods
kubectl get pods -n capx-system

# Find Prism Central credentials
kubectl get secrets -n capx-system | grep -i prism

# Test CAPX permissions
kubectl auth can-i create clusters \
  --as=system:serviceaccount:capx-system:capx-controller-manager
```

### CAREN (Runtime Extensions)
```bash
# Check CAREN pods
kubectl get pods -n caren-system

# Check webhooks
kubectl get validatingwebhookconfigurations,mutatingwebhookconfigurations | grep caren
```

### Nutanix CCM
```bash
# Check CCM pods
kubectl get pods -n kube-system | grep nutanix-cloud

# Extract CCM credentials
kubectl get secret nutanix-ccm-credentials -n kube-system -o json | \
  jq -r '.data.credentials' | base64 -d | jq
```

### Nutanix CSI
```bash
# Check CSI pods
kubectl get pods -n ntnx-system

# Extract CSI credentials
kubectl get secret nutanix-csi-credentials -n ntnx-system -o json | \
  jq -r '.data.key' | base64 -d
```

---

## ğŸ” Automated Testing

### Run Full Pentest Suite
```bash
# Run comprehensive test suite
./scripts/nkp-pentest-suite.sh --output ./pentest-results

# Test specific namespace
./scripts/nkp-pentest-suite.sh --namespace dm-dev-workspace

# Use specific kubeconfig
./scripts/nkp-pentest-suite.sh --kubeconfig /path/to/kubeconfig
```

### Quick Security Audit
```bash
# Run all security scans
./scripts/nkp-pentest-suite.sh && \
kubescape scan framework nsa && \
kubeaudit all && \
trivy k8s cluster
```

---

## ğŸ“Š Risk Assessment Matrix

| Component | Namespace | Critical Issues to Check | Risk Level |
|-----------|-----------|-------------------------|------------|
| **Kommander** | `kommander` | API access, SA tokens, cluster management | ğŸ”´ Critical |
| **CAPX** | `capx-system` | Prism credentials, cluster creation | ğŸ”´ Critical |
| **CAREN** | `caren-system` | Webhook manipulation | ğŸŸ  High |
| **Nutanix CCM** | `kube-system` | Prism credentials | ğŸ”´ Critical |
| **Nutanix CSI** | `ntnx-system` | Storage credentials | ğŸŸ  High |
| **Cilium** | `kube-system` | Network bypass | ğŸŸ  High |
| **MetalLB** | `metallb-system` | IP spoofing | ğŸŸ¡ Medium |

---

## ğŸš¨ Immediate Remediation Checklist

If you find issues, prioritize:

1. âœ… **Rotate all credentials** (Prism Central, CCM, CSI)
2. âœ… **Remove unnecessary cluster-admin bindings**
3. âœ… **Remove privileged containers** (where possible)
4. âœ… **Implement network policies**
5. âœ… **Enable Pod Security Standards**
6. âœ… **Review and restrict service account permissions**
7. âœ… **Enable audit logging**
8. âœ… **Deploy runtime security (Falco)**

---

## ğŸ“š Additional Resources

- [Full Penetration Testing Guide](./BLACK-HAT-PENETRATION-TESTING-GUIDE.md)
- [Security Fix Validation Guide](./SECURITY-FIX-VALIDATION-GUIDE.md)
- [Kubesec Security Guide](./KUBESEC-SECURITY-GUIDE.md)
- [NKP RBAC Guide](./NKP-RBAC-GUIDE.md)

---

## âš ï¸ Legal Disclaimer

**Only perform these tests in authorized environments. Unauthorized penetration testing is illegal.**

---

**Last Updated**: 2025-01-27

