#!/bin/bash
#
# NKP Penetration Testing Suite
# Comprehensive security testing for Nutanix Kubernetes Platform clusters
#
# Usage:
#   ./scripts/nkp-pentest-suite.sh [--kubeconfig <path>] [--namespace <ns>] [--output <dir>]
#
# WARNING: Only use in authorized environments!

set -euo pipefail

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# Default values
# Note: KUBECONFIG environment variable takes precedence over --kubeconfig flag
NAMESPACE=""
OUTPUT_DIR="./pentest-results-$(date +%Y%m%d-%H%M%S)"
VERBOSE=false
INCLUDE_SA_TOKENS=false
KUBECONFIG_FLAG=""

# Parse arguments
while [[ $# -gt 0 ]]; do
  case $1 in
    --kubeconfig)
      KUBECONFIG_FLAG="$2"
      shift 2
      ;;
    --namespace)
      NAMESPACE="$2"
      shift 2
      ;;
    --output)
      OUTPUT_DIR="$2"
      shift 2
      ;;
    --verbose|-v)
      VERBOSE=true
      shift
      ;;
    --include-sa-tokens|--sa-tokens)
      INCLUDE_SA_TOKENS=true
      shift
      ;;
    --help|-h)
      echo "Usage: $0 [OPTIONS]"
      echo ""
      echo "Options:"
      echo "  --kubeconfig <path>     Path to kubeconfig file"
      echo "  --namespace <ns>         Target specific namespace"
      echo "  --output <dir>           Output directory for results"
      echo "  --verbose, -v            Enable verbose output"
      echo "  --include-sa-tokens      Include service account token extraction (can be slow)"
      echo "  --help, -h               Show this help message"
      exit 0
      ;;
    *)
      echo "Unknown option: $1"
      exit 1
      ;;
  esac
done

# Create output directory
mkdir -p "$OUTPUT_DIR"

# Logging function
log() {
  local level=$1
  shift
  local message="$*"
  local timestamp=$(date '+%Y-%m-%d %H:%M:%S')

  case $level in
    INFO)
      echo -e "${BLUE}[INFO]${NC} $message" | tee -a "$OUTPUT_DIR/pentest.log"
      ;;
    WARN)
      echo -e "${YELLOW}[WARN]${NC} $message" | tee -a "$OUTPUT_DIR/pentest.log"
      ;;
    ERROR)
      echo -e "${RED}[ERROR]${NC} $message" | tee -a "$OUTPUT_DIR/pentest.log"
      ;;
    SUCCESS)
      echo -e "${GREEN}[SUCCESS]${NC} $message" | tee -a "$OUTPUT_DIR/pentest.log"
      ;;
  esac
}

# Check prerequisites
check_prerequisites() {
  log INFO "Checking prerequisites..."

  local missing_tools=()

  command -v kubectl >/dev/null 2>&1 || missing_tools+=("kubectl")
  command -v jq >/dev/null 2>&1 || missing_tools+=("jq")

  if [ ${#missing_tools[@]} -ne 0 ]; then
    log ERROR "Missing required tools: ${missing_tools[*]}"
    exit 1
  fi

  # Set KUBECONFIG: environment variable takes precedence over flag
  if [ -n "${KUBECONFIG:-}" ]; then
    log INFO "Using KUBECONFIG from environment: $KUBECONFIG"
    export KUBECONFIG
  elif [ -n "$KUBECONFIG_FLAG" ]; then
    log INFO "Using KUBECONFIG from flag: $KUBECONFIG_FLAG"
    export KUBECONFIG="$KUBECONFIG_FLAG"
  else
    log INFO "Using default kubectl context (KUBECONFIG not set)"
  fi

  # Check kubectl connectivity
  if ! kubectl cluster-info >/dev/null 2>&1; then
    log ERROR "Cannot connect to Kubernetes cluster"
    log INFO "Set KUBECONFIG environment variable or use --kubeconfig flag"
    exit 1
  fi

  log SUCCESS "Prerequisites check passed"
}

# Phase 1: Discovery
phase1_discovery() {
  log INFO "=== Phase 1: Discovery ==="

  local ns_flag=""
  [ -n "$NAMESPACE" ] && ns_flag="-n $NAMESPACE" || ns_flag="--all-namespaces"

  # Cluster information
  log INFO "Collecting cluster information..."
  kubectl cluster-info > "$OUTPUT_DIR/cluster-info.txt" 2>&1
  kubectl get nodes -o wide > "$OUTPUT_DIR/nodes.txt" 2>&1

  # Namespaces
  log INFO "Enumerating namespaces..."
  kubectl get namespaces -o json > "$OUTPUT_DIR/namespaces.json" 2>&1

  # Pods
  log INFO "Enumerating pods..."
  kubectl get pods $ns_flag -o json > "$OUTPUT_DIR/pods.json" 2>&1
  kubectl get pods $ns_flag -o wide > "$OUTPUT_DIR/pods.txt" 2>&1

  # Services
  log INFO "Enumerating services..."
  kubectl get services $ns_flag -o json > "$OUTPUT_DIR/services.json" 2>&1
  kubectl get services $ns_flag -o wide > "$OUTPUT_DIR/services.txt" 2>&1

  # Service Accounts
  log INFO "Enumerating service accounts..."
  kubectl get serviceaccounts $ns_flag -o json > "$OUTPUT_DIR/serviceaccounts.json" 2>&1

  # Nutanix-specific components (including kube-system and ntnx-system)
  log INFO "Identifying Nutanix components..."
  {
    echo "=== Nutanix Namespaces ==="
    kubectl get namespaces | grep -E "kommander|capx|caren|ntnx" || true
    echo ""
    echo "=== Kommander Pods ==="
    kubectl get pods -n kommander 2>/dev/null || true
    echo ""
    echo "=== CAPX Pods ==="
    kubectl get pods -n capx-system 2>/dev/null || true
    echo ""
    echo "=== CAREN Pods ==="
    kubectl get pods -n caren-system 2>/dev/null || true
    echo ""
    echo "=== Nutanix System Pods (ntnx-system) ==="
    kubectl get pods -n ntnx-system 2>/dev/null || true
    echo ""
    echo "=== Nutanix Components in kube-system ==="
    kubectl get pods -n kube-system | grep -iE "nutanix|ccm|cilium" || true
    echo ""
    echo "=== Nutanix Secrets in kube-system ==="
    kubectl get secrets -n kube-system | grep -iE "nutanix|ccm" || true
  } > "$OUTPUT_DIR/nutanix-components.txt"

  log SUCCESS "Discovery phase complete"
}

# Phase 2: Credential Extraction
phase2_credentials() {
  log INFO "=== Phase 2: Credential Extraction ==="

  local ns_flag=""
  [ -n "$NAMESPACE" ] && ns_flag="-n $NAMESPACE" || ns_flag="--all-namespaces"

  # List all secrets
  log INFO "Enumerating secrets..."
  kubectl get secrets $ns_flag -o json > "$OUTPUT_DIR/secrets.json" 2>&1
  kubectl get secrets $ns_flag > "$OUTPUT_DIR/secrets.txt" 2>&1

  # Nutanix-specific secrets
  log INFO "Searching for Nutanix credentials..."
  {
    echo "=== Prism Central Credentials ==="
    kubectl get secrets $ns_flag | grep -iE "prism|nutanix|pc-credentials" || true
    echo ""
    echo "=== CCM Credentials ==="
    kubectl get secrets $ns_flag | grep -iE "ccm|cloud-controller" || true
    echo ""
    echo "=== CSI Credentials ==="
    kubectl get secrets $ns_flag | grep -iE "csi|storage" || true
    echo ""
    echo "=== Nutanix Secrets in kube-system ==="
    kubectl get secrets -n kube-system | grep -iE "nutanix|ccm" || true
    echo ""
    echo "=== Nutanix Secrets in ntnx-system ==="
    kubectl get secrets -n ntnx-system 2>/dev/null | grep -iE "nutanix|csi" || true
    echo ""
    echo "=== Kommander Secrets ==="
    kubectl get secrets -n kommander 2>/dev/null || true
    echo ""
    echo "=== Sealed Secrets ==="
    kubectl get sealedsecrets $ns_flag 2>/dev/null || true
  } > "$OUTPUT_DIR/nutanix-secrets.txt"

  # Service account tokens - SKIPPED here, will run at end if enabled
  log INFO "Skipping service account token extraction (will run at end if --include-sa-tokens is set)..."
  {
    echo "=== Service Account Token Extraction ==="
    echo ""
    echo "‚ö†Ô∏è  This step is SKIPPED by default for performance reasons."
    echo "   Token extraction can be slow when scanning all namespaces."
    echo ""
    echo "To enable: Run with --include-sa-tokens flag"
    echo "  ./scripts/nkp-pentest-suite.sh --include-sa-tokens [other options]"
    echo ""
    echo "=== Why This Is Important ==="
    echo "Service account tokens are critical attack vectors:"
    echo "  - Tokens can be extracted from compromised pods"
    echo "  - Tokens grant Kubernetes API access based on RBAC permissions"
    echo "  - High-privilege service accounts (e.g., cluster-admin) are prime targets"
    echo "  - Tokens can be used for lateral movement and privilege escalation"
    echo ""
    echo "=== How to Run This Manually ==="
    echo ""
    echo "For a specific namespace:"
    echo "  kubectl get serviceaccounts -n <namespace> -o json | \\"
    echo "    jq -r '.items[] | \"\(.metadata.name)\"' | \\"
    echo "    while read sa; do"
    echo "      echo \"Namespace: <namespace>, ServiceAccount: \$sa\""
    echo "      kubectl get secret -n <namespace> -o json | \\"
    echo "        jq -r \".items[] | select(.metadata.annotations.\\\"kubernetes.io/service-account.name\\\" == \\\"\$sa\\\") | .metadata.name\""
    echo "    done"
    echo ""
    echo "Quick check for high-privilege service accounts:"
    echo "  kubectl get serviceaccounts --all-namespaces -o wide"
    echo "  kubectl get clusterrolebindings -o json | jq '.items[] | select(.roleRef.name == \"cluster-admin\")'"
    echo ""
    echo "Find all service account token secrets:"
    echo "  kubectl get secrets --all-namespaces -o json | \\"
    echo "    jq '.items[] | select(.type == \"kubernetes.io/service-account-token\") | \"\(.metadata.namespace)/\(.metadata.name)\"'"
    echo ""
    echo "=== Current Service Accounts in Target Namespace(s) ==="
    kubectl get serviceaccounts $ns_flag -o wide 2>/dev/null || true
  } > "$OUTPUT_DIR/sa-tokens.txt" 2>&1

  log SUCCESS "Credential extraction phase complete"
}

# Phase 7: Service Account Token Extraction (runs at end if enabled)
phase7_sa_tokens() {
  if [ "$INCLUDE_SA_TOKENS" = true ]; then
    log INFO "=== Phase 7: Service Account Token Extraction ==="
    log INFO "Extracting service account tokens (this may take a while, but you'll see progress)..."

    local ns_flag=""
    [ -n "$NAMESPACE" ] && ns_flag="-n $NAMESPACE" || ns_flag="--all-namespaces"

    {
      echo "=== Service Account Token Extraction ==="
      echo ""
      echo "Extracting service account tokens with progress indicators..."
      echo "This step runs at the end so you have all other results even if it's slow."
      echo ""

      if [ -n "$NAMESPACE" ]; then
        # Single namespace - faster
        log INFO "Processing namespace: $NAMESPACE"
        local sa_list=($(kubectl get serviceaccounts -n "$NAMESPACE" -o jsonpath='{.items[*].metadata.name}' 2>/dev/null))
        local sa_count=${#sa_list[@]}
        local processed=0

        for sa in "${sa_list[@]}"; do
          processed=$((processed + 1))
          if [ $((processed % 10)) -eq 0 ] || [ $processed -eq 1 ]; then
            log INFO "  Processed $processed/$sa_count service accounts..."
          fi
          echo "Namespace: $NAMESPACE, ServiceAccount: $sa"
          kubectl get secret -n "$NAMESPACE" -o json 2>/dev/null | \
            jq -r ".items[] | select(.metadata.annotations.\"kubernetes.io/service-account.name\" == \"$sa\") | \"  Token Secret: \(.metadata.name)\"" || true
        done
        log SUCCESS "Completed token extraction for namespace: $NAMESPACE ($sa_count service accounts)"
      else
        # All namespaces - show progress
        local namespaces=($(kubectl get namespaces -o jsonpath='{.items[*].metadata.name}' 2>/dev/null))
        local total_ns=${#namespaces[@]}
        local processed_ns=0

        log INFO "Processing $total_ns namespaces (this may take several minutes)..."

        for ns in "${namespaces[@]}"; do
          processed_ns=$((processed_ns + 1))
          if [ $((processed_ns % 5)) -eq 0 ] || [ $processed_ns -eq 1 ] || [ $processed_ns -eq $total_ns ]; then
            log INFO "  Processing namespace $processed_ns/$total_ns: $ns"
          fi

          local sa_list=($(kubectl get serviceaccounts -n "$ns" -o jsonpath='{.items[*].metadata.name}' 2>/dev/null))
          for sa in "${sa_list[@]}"; do
            echo "Namespace: $ns, ServiceAccount: $sa"
            kubectl get secret -n "$ns" -o json 2>/dev/null | \
              jq -r ".items[] | select(.metadata.annotations.\"kubernetes.io/service-account.name\" == \"$sa\") | \"  Token Secret: \(.metadata.name)\"" 2>/dev/null || true
          done
        done
        log SUCCESS "Completed token extraction for $total_ns namespaces"
      fi
    } > "$OUTPUT_DIR/sa-tokens.txt" 2>&1

    log SUCCESS "Service account token extraction complete"
  fi
}

# Phase 3: RBAC Testing
phase3_rbac() {
  log INFO "=== Phase 3: RBAC Testing ==="

  # Cluster roles
  log INFO "Analyzing cluster roles..."
  kubectl get clusterroles -o json > "$OUTPUT_DIR/clusterroles.json" 2>&1

  # Cluster role bindings
  log INFO "Analyzing cluster role bindings..."
  kubectl get clusterrolebindings -o json > "$OUTPUT_DIR/clusterrolebindings.json" 2>&1

  # Find cluster-admin bindings
  log INFO "Finding cluster-admin bindings..."
  {
    echo "=== Cluster Admin Bindings ==="
    kubectl get clusterrolebindings -o json | \
      jq -r '.items[] | select(.roleRef.name == "cluster-admin") | "\(.metadata.name) -> \(.subjects[]?.name // "unknown")"'
    echo ""
    echo "=== Wildcard Permissions (Detailed) ==="
    echo ""
    echo "ClusterRoles with wildcard verbs (*) - showing which rules and resources:"
    echo ""
    kubectl get clusterroles -o json | \
      jq -r '.items[] |
        select(.rules[]?.verbs[]? == "*") |
        "ClusterRole: \(.metadata.name)\n" +
        "  Rules with wildcards:\n" +
        (.rules[] | select(.verbs[]? == "*") |
          "    - Verbs: *\n" +
          "      Resources: \(.resources // ["*"] | join(", "))\n" +
          "      API Groups: \(.apiGroups // ["*"] | join(", "))\n" +
          "      Resource Names: \(.resourceNames // [] | if length > 0 then join(", ") else "all" end)\n" +
          "      Non-Resource URLs: \(.nonResourceURLs // [] | if length > 0 then join(", ") else "none" end)\n"
        ) +
        "\n  How to investigate:\n" +
        "    # View the full ClusterRole definition:\n" +
        "    kubectl get clusterrole \(.metadata.name) -o yaml\n" +
        "    \n" +
        "    # Find ClusterRoleBindings using this role:\n" +
        "    kubectl get clusterrolebindings -o json | jq \".items[] | select(.roleRef.name == \\\"\(.metadata.name)\\\") | {name: .metadata.name, subjects: .subjects}\"\n" +
        "    \n" +
        "    # Find RoleBindings (namespace-scoped) using this role:\n" +
        "    kubectl get rolebindings --all-namespaces -o json | jq \".items[] | select(.roleRef.name == \\\"\(.metadata.name)\\\") | {namespace: .metadata.namespace, name: .metadata.name, subjects: .subjects}\"\n" +
        "    \n" +
        "    # If no output from above commands, this role may not be bound anywhere\n" +
        "\n" +
        "---\n"
    '
    echo ""
    echo "=== Summary: ClusterRoles with Wildcards ==="
    kubectl get clusterroles -o json | \
      jq -r '.items[] | select(.rules[]?.verbs[]? == "*") | .metadata.name' | \
      sort -u | \
      while read role; do
        echo "  - $role"
        echo "    Bound to:"
        # Check cluster role bindings
        local crb_count=0
        kubectl get clusterrolebindings -o json 2>/dev/null | \
          jq -r ".items[] | select(.roleRef.name == \"$role\") | \"      ClusterRoleBinding: \(.metadata.name) -> \(.subjects[]?.name // .subjects[]?.kind // \"unknown\" | tostring)\"" | \
          while IFS= read -r line; do
            echo "$line"
            crb_count=$((crb_count + 1))
          done || true
        # Check role bindings (namespace-scoped)
        local rb_count=0
        kubectl get rolebindings --all-namespaces -o json 2>/dev/null | \
          jq -r ".items[] | select(.roleRef.name == \"$role\") | \"      RoleBinding: \(.metadata.namespace)/\(.metadata.name) -> \(.subjects[]?.name // .subjects[]?.kind // \"unknown\" | tostring)\"" | \
          head -5 | \
          while IFS= read -r line; do
            echo "$line"
            rb_count=$((rb_count + 1))
          done || true
        # Show message if no bindings found
        if [ $crb_count -eq 0 ] && [ $rb_count -eq 0 ]; then
          echo "      (No bindings found - this role may not be in use)"
        fi
        echo ""
      done
  } > "$OUTPUT_DIR/rbac-analysis.txt"

  # Test service account permissions
  log INFO "Testing service account permissions..."
  {
    echo "=== Service Account Permission Test ==="
    for ns in kommander capx-system caren-system ntnx-system; do
      if kubectl get namespace "$ns" >/dev/null 2>&1; then
        for sa in $(kubectl get serviceaccounts -n "$ns" -o jsonpath='{.items[*].metadata.name}'); do
          echo "Testing: system:serviceaccount:$ns:$sa"
          kubectl auth can-i get pods --all-namespaces --as="system:serviceaccount:$ns:$sa" 2>/dev/null || true
          kubectl auth can-i create pods --all-namespaces --as="system:serviceaccount:$ns:$sa" 2>/dev/null || true
          kubectl auth can-i get secrets --all-namespaces --as="system:serviceaccount:$ns:$sa" 2>/dev/null || true
        done
      fi
    done
  } > "$OUTPUT_DIR/sa-permissions.txt"

  log SUCCESS "RBAC testing phase complete"
}

# Phase 4: Security Context Testing
phase4_security_contexts() {
  log INFO "=== Phase 4: Security Context Testing ==="

  local ns_flag=""
  [ -n "$NAMESPACE" ] && ns_flag="-n $NAMESPACE" || ns_flag="--all-namespaces"

  # Privileged containers
  log INFO "Finding privileged containers..."
  kubectl get pods $ns_flag -o json | \
    jq -r '.items[] | select(.spec.containers[]?.securityContext.privileged == true) | "\(.metadata.namespace)/\(.metadata.name)"' \
    > "$OUTPUT_DIR/privileged-pods.txt" 2>&1 || true

  # Host network pods
  log INFO "Finding host network pods..."
  kubectl get pods $ns_flag -o json | \
    jq -r '.items[] | select(.spec.hostNetwork == true) | "\(.metadata.namespace)/\(.metadata.name)"' \
    > "$OUTPUT_DIR/hostnetwork-pods.txt" 2>&1 || true

  # Host path volumes
  log INFO "Finding host path volumes..."
  kubectl get pods $ns_flag -o json | \
    jq -r '.items[] | select(.spec.volumes[]?.hostPath != null) | "\(.metadata.namespace)/\(.metadata.name): \(.spec.volumes[]?.hostPath.path // "unknown")"' \
    > "$OUTPUT_DIR/hostpath-volumes.txt" 2>&1 || true

  # Dangerous capabilities
  log INFO "Finding dangerous capabilities..."
  kubectl get pods $ns_flag -o json | \
    jq -r '.items[] | select(.spec.containers[]?.securityContext.capabilities.add[]? |
      contains("SYS_ADMIN") or contains("NET_ADMIN") or contains("SYS_PTRACE") or contains("SYS_MODULE")) |
      "\(.metadata.namespace)/\(.metadata.name)"' \
    > "$OUTPUT_DIR/dangerous-capabilities.txt" 2>&1 || true

  # Root containers
  log INFO "Finding root containers..."
  kubectl get pods $ns_flag -o json | \
    jq -r '.items[] | select(.spec.containers[]?.securityContext.runAsUser == 0 or
      (.spec.securityContext.runAsUser == 0)) | "\(.metadata.namespace)/\(.metadata.name)"' \
    > "$OUTPUT_DIR/root-containers.txt" 2>&1 || true

  # Security context summary
  {
    echo "=== Security Context Summary ==="
    echo "Privileged Pods: $(wc -l < "$OUTPUT_DIR/privileged-pods.txt" | tr -d ' ')"
    echo "Host Network Pods: $(wc -l < "$OUTPUT_DIR/hostnetwork-pods.txt" | tr -d ' ')"
    echo "Host Path Volumes: $(wc -l < "$OUTPUT_DIR/hostpath-volumes.txt" | tr -d ' ')"
    echo "Dangerous Capabilities: $(wc -l < "$OUTPUT_DIR/dangerous-capabilities.txt" | tr -d ' ')"
    echo "Root Containers: $(wc -l < "$OUTPUT_DIR/root-containers.txt" | tr -d ' ')"
  } > "$OUTPUT_DIR/security-context-summary.txt"

  log SUCCESS "Security context testing phase complete"
}

# Phase 5: Network Security Testing
phase5_network() {
  log INFO "=== Phase 5: Network Security Testing ==="

  local ns_flag=""
  [ -n "$NAMESPACE" ] && ns_flag="-n $NAMESPACE" || ns_flag="--all-namespaces"

  # Network policies
  log INFO "Analyzing network policies..."
  kubectl get networkpolicies $ns_flag -o json > "$OUTPUT_DIR/networkpolicies.json" 2>&1 || true
  kubectl get networkpolicies $ns_flag > "$OUTPUT_DIR/networkpolicies.txt" 2>&1 || true

  # Exposed services
  log INFO "Finding exposed services..."
  {
    echo "=== LoadBalancer Services ==="
    kubectl get services $ns_flag | grep LoadBalancer || true
    echo ""
    echo "=== NodePort Services ==="
    kubectl get services $ns_flag | grep NodePort || true
    echo ""
    echo "=== External IPs ==="
    kubectl get services $ns_flag -o json | \
      jq -r '.items[] | select(.spec.externalIPs != null) | "\(.metadata.namespace)/\(.metadata.name): \(.spec.externalIPs[]?)"' || true
  } > "$OUTPUT_DIR/exposed-services.txt"

  # Ingress resources
  log INFO "Analyzing ingress resources..."
  kubectl get ingress $ns_flag -o json > "$OUTPUT_DIR/ingress.json" 2>&1 || true
  kubectl get ingress $ns_flag > "$OUTPUT_DIR/ingress.txt" 2>&1 || true

  log SUCCESS "Network security testing phase complete"
}

# Phase 6: Nutanix Component-Specific Tests
phase6_nutanix_components() {
  log INFO "=== Phase 6: Nutanix Component-Specific Tests ==="

  # Kommander
  if kubectl get namespace kommander >/dev/null 2>&1; then
    log INFO "Testing Kommander components..."
    {
      echo "=== Kommander Pods ==="
      kubectl get pods -n kommander -o wide
      echo ""
      echo "=== Kommander Service Accounts ==="
      kubectl get serviceaccounts -n kommander
      echo ""
      echo "=== Kommander Secrets ==="
      kubectl get secrets -n kommander
      echo ""
      echo "=== Kommander RBAC ==="
      kubectl get rolebindings,clusterrolebindings -n kommander
    } > "$OUTPUT_DIR/kommander-analysis.txt"
  fi

  # CAPX
  if kubectl get namespace capx-system >/dev/null 2>&1; then
    log INFO "Testing CAPX components..."
    {
      echo "=== CAPX Pods ==="
      kubectl get pods -n capx-system -o wide
      echo ""
      echo "=== CAPX Service Accounts ==="
      kubectl get serviceaccounts -n capx-system
      echo ""
      echo "=== CAPX Secrets (Prism Credentials) ==="
      kubectl get secrets -n capx-system | grep -iE "prism|nutanix" || true
      echo ""
      echo "=== CAPX RBAC ==="
      kubectl get clusterrolebindings | grep capx || true
    } > "$OUTPUT_DIR/capx-analysis.txt"
  fi

  # CAREN
  if kubectl get namespace caren-system >/dev/null 2>&1; then
    log INFO "Testing CAREN components..."
    {
      echo "=== CAREN Pods ==="
      kubectl get pods -n caren-system -o wide
      echo ""
      echo "=== CAREN Webhooks ==="
      kubectl get validatingwebhookconfigurations,mutatingwebhookconfigurations | grep caren || true
      echo ""
      echo "=== CAREN Runtime Extensions ==="
      kubectl get runtimeextensions -n caren-system 2>/dev/null || true
    } > "$OUTPUT_DIR/caren-analysis.txt"
  fi

  # Nutanix CCM (in kube-system)
  log INFO "Testing Nutanix CCM..."
  {
    echo "=== CCM Pods (kube-system) ==="
    kubectl get pods -n kube-system | grep -iE "nutanix|ccm|cloud-controller" || true
    echo ""
    echo "=== CCM Credentials (kube-system) ==="
    kubectl get secrets -n kube-system | grep -iE "nutanix|ccm|cloud-controller" || true
    echo ""
    echo "=== CCM Service Account (kube-system) ==="
    kubectl get serviceaccounts -n kube-system | grep -iE "nutanix|ccm" || true
    echo ""
    echo "=== Other Nutanix Components in kube-system ==="
    kubectl get pods -n kube-system -o wide | grep -iE "nutanix|cilium" || true
    kubectl get secrets -n kube-system | grep -iE "nutanix" || true
  } > "$OUTPUT_DIR/ccm-analysis.txt"

  # Nutanix CSI and other components in ntnx-system
  if kubectl get namespace ntnx-system >/dev/null 2>&1; then
    log INFO "Testing Nutanix CSI and ntnx-system components..."
    {
      echo "=== All Pods in ntnx-system ==="
      kubectl get pods -n ntnx-system -o wide
      echo ""
      echo "=== All Secrets in ntnx-system ==="
      kubectl get secrets -n ntnx-system
      echo ""
      echo "=== Service Accounts in ntnx-system ==="
      kubectl get serviceaccounts -n ntnx-system
      echo ""
      echo "=== CSI Storage Classes ==="
      kubectl get storageclass | grep -iE "nutanix" || true
      echo ""
      echo "=== RBAC for ntnx-system ==="
      kubectl get rolebindings,clusterrolebindings -n ntnx-system 2>/dev/null || true
    } > "$OUTPUT_DIR/csi-analysis.txt"
  fi

  log SUCCESS "Nutanix component testing phase complete"
}

# Generate summary report
generate_summary() {
  log INFO "Generating summary report..."

  {
    echo "=== NKP Penetration Testing Summary ==="
    echo "Date: $(date)"
    echo "Cluster: $(kubectl config current-context 2>/dev/null || echo 'unknown')"
    echo ""
    echo "=== Findings Summary ==="
    echo ""
    echo "Discovery:"
    echo "  - Namespaces: $(kubectl get namespaces --no-headers 2>/dev/null | wc -l | tr -d ' ')"
    echo "  - Pods: $(kubectl get pods --all-namespaces --no-headers 2>/dev/null | wc -l | tr -d ' ')"
    echo "  - Services: $(kubectl get services --all-namespaces --no-headers 2>/dev/null | wc -l | tr -d ' ')"
    echo ""
    echo "Security Issues:"
    echo "  - Privileged Pods: $(wc -l < "$OUTPUT_DIR/privileged-pods.txt" 2>/dev/null | tr -d ' ' || echo '0')"
    echo "  - Host Network Pods: $(wc -l < "$OUTPUT_DIR/hostnetwork-pods.txt" 2>/dev/null | tr -d ' ' || echo '0')"
    echo "  - Root Containers: $(wc -l < "$OUTPUT_DIR/root-containers.txt" 2>/dev/null | tr -d ' ' || echo '0')"
    echo "  - Dangerous Capabilities: $(wc -l < "$OUTPUT_DIR/dangerous-capabilities.txt" 2>/dev/null | tr -d ' ' || echo '0')"
    echo ""
    echo "RBAC:"
    echo "  - Cluster Admin Bindings: $(grep -c "cluster-admin" "$OUTPUT_DIR/rbac-analysis.txt" 2>/dev/null || echo '0')"
    echo ""
    echo "Network:"
    echo "  - LoadBalancer Services: $(grep -c "LoadBalancer" "$OUTPUT_DIR/exposed-services.txt" 2>/dev/null || echo '0')"
    echo "  - NodePort Services: $(grep -c "NodePort" "$OUTPUT_DIR/exposed-services.txt" 2>/dev/null || echo '0')"
    echo ""
    echo "=== Detailed Reports ==="
    echo "All detailed reports are available in: $OUTPUT_DIR"
    echo ""
    echo "Key Files:"
    echo "  - pentest.log: Full execution log"
    echo "  - rbac-analysis.txt: RBAC findings"
    echo "  - security-context-summary.txt: Security context summary"
    echo "  - nutanix-components.txt: Nutanix component inventory"
    echo "  - nutanix-secrets.txt: Nutanix credential locations"
  } > "$OUTPUT_DIR/SUMMARY.txt"

  log SUCCESS "Summary report generated: $OUTPUT_DIR/SUMMARY.txt"
}

# Generate actionable items document
generate_actionable_items() {
  log INFO "Generating actionable items document..."

  local cluster_admin_count=$(grep -c "->" "$OUTPUT_DIR/rbac-analysis.txt" 2>/dev/null | head -1 || echo "0")
  local wildcard_roles=$(grep -c "^  - " "$OUTPUT_DIR/rbac-analysis.txt" 2>/dev/null | tail -1 || echo "0")
  local privileged_pods=$(wc -l < "$OUTPUT_DIR/privileged-pods.txt" 2>/dev/null | tr -d ' ' || echo "0")
  local hostnetwork_pods=$(wc -l < "$OUTPUT_DIR/hostnetwork-pods.txt" 2>/dev/null | tr -d ' ' || echo "0")
  local root_containers=$(wc -l < "$OUTPUT_DIR/root-containers.txt" 2>/dev/null | tr -d ' ' || echo "0")
  local dangerous_caps=$(wc -l < "$OUTPUT_DIR/dangerous-capabilities.txt" 2>/dev/null | tr -d ' ' || echo "0")
  local exposed_services=$(grep -cE "LoadBalancer|NodePort" "$OUTPUT_DIR/services.txt" 2>/dev/null || echo "0")

  {
    echo "# Actionable Security Items - NKP Pentest Results"
    echo ""
    echo "**Date**: $(date '+%Y-%m-%d %H:%M:%S')"
    echo "**Cluster**: $(kubectl config current-context 2>/dev/null || echo 'unknown')"
    echo "**Report Location**: \`$OUTPUT_DIR\`"
    echo ""
    echo "---"
    echo ""
    echo "## üî¥ CRITICAL PRIORITY (Fix Immediately)"
    echo ""
    echo "### 1. Review Cluster-Admin Bindings ($cluster_admin_count found)"
    echo ""
    echo "**Issue**: Multiple subjects have cluster-admin privileges"
    echo ""
    echo "**Found Bindings**:"
    grep "->" "$OUTPUT_DIR/rbac-analysis.txt" 2>/dev/null | head -15 | sed 's/^/  - /' || echo "  (See rbac-analysis.txt for details)"
    echo ""
    echo "**Action Items**:"
    echo '```bash'
    echo "# Review each binding to determine if cluster-admin is necessary"
    echo "kubectl get clusterrolebindings -o yaml | grep -A 10 \"cluster-admin\""
    echo ""
    echo "# For each binding, ask:"
    echo "# 1. Does this service account/user REALLY need cluster-admin?"
    echo "# 2. Can we use a more restrictive role?"
    echo "# 3. Can we scope permissions to specific namespaces?"
    echo '```'
    echo ""
    echo "**Priority**: Review and reduce cluster-admin bindings to minimum necessary"
    echo ""
    echo "---"
    echo ""
    echo "### 2. Audit Wildcard Permissions ($wildcard_roles ClusterRoles found)"
    echo ""
    echo "**Issue**: Many ClusterRoles use wildcard verbs (\`*\`) granting all actions"
    echo ""
    echo "**Action Items**:"
    echo '```bash'
    echo "# 1. Review the detailed wildcard analysis"
    echo "cat $OUTPUT_DIR/rbac-analysis.txt | grep -A 20 \"ClusterRole:\""
    echo ""
    echo "# 2. For each role with wildcards, determine:"
    echo "#    - Is the wildcard necessary?"
    echo "#    - Can we replace with specific verbs (get, list, watch, create, etc.)?"
    echo ""
    echo "# 3. Focus on custom roles first (not system roles like cluster-admin)"
    echo "kubectl get clusterroles | grep -v \"system:\" | grep -v \"kubeadm:\""
    echo '```'
    echo ""
    echo "**Priority**: Review custom roles with wildcards, replace with specific verbs where possible"
    echo ""
    echo "---"
    echo ""
    echo "## üü† HIGH PRIORITY (Fix Within 1 Week)"
    echo ""
    echo "### 3. Review Exposed Services ($exposed_services found)"
    echo ""
    echo "**Action Items**:"
    echo '```bash'
    echo "# Check for LoadBalancer and NodePort services"
    echo "cat $OUTPUT_DIR/services.txt | grep -E \"LoadBalancer|NodePort\""
    echo ""
    echo "# For each exposed service:"
    echo "# 1. Verify it needs to be exposed externally"
    echo "# 2. Check if NetworkPolicy restricts access"
    echo "# 3. Ensure TLS is enabled"
    echo "# 4. Review firewall rules"
    echo '```'
    echo ""
    echo "**Priority**: Minimize external exposure, use Ingress with TLS instead"
    echo ""
    echo "---"
    echo ""
    echo "### 4. Audit Nutanix Component Secrets"
    echo ""
    echo "**Action Items**:"
    echo '```bash'
    echo "# Review all Nutanix-related secrets"
    echo "cat $OUTPUT_DIR/nutanix-secrets.txt"
    echo ""
    echo "# For each secret:"
    echo "# 1. Verify they'\''re using Sealed Secrets (not plaintext)"
    echo "# 2. Check if credentials are rotated regularly"
    echo "# 3. Review who has access to these secrets"
    echo "# 4. Ensure secrets are not in Git (use sealed-secrets)"
    echo ""
    echo "# Check sealed secrets usage"
    echo "kubectl get sealedsecrets --all-namespaces"
    echo '```'
    echo ""
    echo "**Priority**: Ensure all sensitive credentials use Sealed Secrets, rotate regularly"
    echo ""
    echo "---"
    echo ""
    echo "### 5. Review Service Account Permissions"
    echo ""
    echo "**Action Items**:"
    echo '```bash'
    echo "# Review service account permissions test results"
    echo "cat $OUTPUT_DIR/sa-permissions.txt"
    echo ""
    echo "# For each service account with high permissions:"
    echo "# 1. Verify the permissions are necessary"
    echo "# 2. Apply principle of least privilege"
    echo "# 3. Check if permissions can be scoped to specific namespaces"
    echo '```'
    echo ""
    echo "**Priority**: Review and restrict service account permissions"
    echo ""
    echo "---"
    echo ""
    echo "## üü° MEDIUM PRIORITY (Fix Within 1 Month)"
    echo ""
    echo "### 6. Review Pod Security Contexts"
    echo ""
    echo "**Findings**:"
    echo "  - Privileged Pods: $privileged_pods"
    echo "  - Host Network Pods: $hostnetwork_pods"
    echo "  - Root Containers: $root_containers"
    echo "  - Dangerous Capabilities: $dangerous_caps"
    echo ""
    echo "**Action Items**:"
    echo '```bash'
    echo "# Review security context violations"
    echo "# Use the pod-security-audit.sh script for detailed analysis"
    echo "./scripts/pod-security-audit.sh --namespace <namespace> --pod <pod-name>"
    echo '```'
    echo ""
    echo "**Priority**: Harden pod security contexts where possible (some system pods may require privileged mode)"
    echo ""
    echo "---"
    echo ""
    echo "### 7. Implement Network Policies"
    echo ""
    echo "**Action Items**:"
    echo '```bash'
    echo "# Check current network policies"
    echo "kubectl get networkpolicies --all-namespaces"
    echo ""
    echo "# Review if network policies are enforced"
    echo "# Implement default-deny policies"
    echo "# Allow only necessary traffic"
    echo '```'
    echo ""
    echo "**Priority**: Implement network policies for defense in depth"
    echo ""
    echo "---"
    echo ""
    echo "## üìã RECOMMENDED ACTIONS"
    echo ""
    echo "### Immediate (This Week)"
    echo ""
    echo "1. ‚úÖ **Review cluster-admin bindings** - Reduce to minimum necessary"
    echo "2. ‚úÖ **Audit wildcard permissions** - Focus on custom roles"
    echo "3. ‚úÖ **Review exposed services** - Minimize external exposure"
    echo "4. ‚úÖ **Verify Sealed Secrets usage** - Ensure no plaintext secrets"
    echo ""
    echo "### Short Term (This Month)"
    echo ""
    echo "5. ‚úÖ **Review service account permissions** - Apply least privilege"
    echo "6. ‚úÖ **Harden pod security contexts** - Where possible without breaking functionality"
    echo "7. ‚úÖ **Implement network policies** - Default deny, explicit allow"
    echo "8. ‚úÖ **Enable audit logging** - Track all API access"
    echo ""
    echo "### Long Term (Ongoing)"
    echo ""
    echo "9. ‚úÖ **Regular security audits** - Run pentest suite monthly"
    echo "10. ‚úÖ **Credential rotation** - Rotate Prism Central, CCM, CSI credentials quarterly"
    echo "11. ‚úÖ **Policy enforcement** - Enable Gatekeeper/Kyverno policies in enforce mode"
    echo "12. ‚úÖ **Security monitoring** - Deploy Falco or similar runtime security tool"
    echo ""
    echo "---"
    echo ""
    echo "## üîç INVESTIGATION COMMANDS"
    echo ""
    echo "### Review Specific Findings"
    echo ""
    echo '```bash'
    echo "# Cluster-admin bindings"
    echo "kubectl get clusterrolebindings -o json | \\"
    echo "  jq '\''.items[] | select(.roleRef.name == \"cluster-admin\")'\''"
    echo ""
    echo "# Wildcard permissions for a specific role"
    echo "kubectl get clusterrole admin -o yaml"
    echo ""
    echo "# Find who has access to a specific role"
    echo "kubectl get clusterrolebindings -o json | \\"
    echo "  jq '\''.items[] | select(.roleRef.name == \"admin\")'\''"
    echo ""
    echo "# Check service account permissions"
    echo "kubectl auth can-i --list \\"
    echo "  --as=system:serviceaccount:kommander:kommander-appmanagement"
    echo ""
    echo "# Review exposed services"
    echo "kubectl get services --all-namespaces | grep -E \"LoadBalancer|NodePort\""
    echo ""
    echo "# Check for privileged pods"
    echo "kubectl get pods --all-namespaces -o json | \\"
    echo "  jq '\''.items[] | select(.spec.containers[]?.securityContext.privileged == true)'\''"
    echo '```'
    echo ""
    echo "---"
    echo ""
    echo "## üìä METRICS TO TRACK"
    echo ""
    echo "- **Cluster-admin bindings**: Target < 5 (currently $cluster_admin_count)"
    echo "- **Wildcard permissions**: Target < 10 custom roles (currently $wildcard_roles)"
    echo "- **Exposed services**: Target < 3 (currently $exposed_services)"
    echo "- **Privileged pods**: Target < 5 system pods only (currently $privileged_pods)"
    echo "- **Root containers**: Target < 10 system pods only (currently $root_containers)"
    echo ""
    echo "---"
    echo ""
    echo "## üìö REFERENCE DOCUMENTATION"
    echo ""
    echo "- **RBAC Analysis**: \`$OUTPUT_DIR/rbac-analysis.txt\`"
    echo "- **Nutanix Secrets**: \`$OUTPUT_DIR/nutanix-secrets.txt\`"
    echo "- **Services**: \`$OUTPUT_DIR/services.txt\`"
    echo "- **Service Account Permissions**: \`$OUTPUT_DIR/sa-permissions.txt\`"
    echo "- **Security Context Summary**: \`$OUTPUT_DIR/security-context-summary.txt\`"
    echo ""
    echo "---"
    echo ""
    echo "## ‚ö†Ô∏è NOTES"
    echo ""
    echo "- Some findings may be expected (e.g., system components requiring privileged access)"
    echo "- Review each finding in context before making changes"
    echo "- Test changes in non-production first"
    echo "- Some NKP/Kommander components may require elevated permissions - verify with Nutanix documentation"
    echo ""
    echo "---"
    echo ""
    echo "**Next Steps**: "
    echo "1. Review this document with your team"
    echo "2. Prioritize items based on your security requirements"
    echo "3. Create tickets/tasks for each actionable item"
    echo "4. Schedule follow-up pentest in 1 month to track progress"
  } > "$OUTPUT_DIR/ACTIONABLE-ITEMS.md"

  log SUCCESS "Actionable items document generated: $OUTPUT_DIR/ACTIONABLE-ITEMS.md"
}

# Main execution
main() {
  log INFO "Starting NKP Penetration Testing Suite"
  log INFO "Output directory: $OUTPUT_DIR"
  if [ "$INCLUDE_SA_TOKENS" = true ]; then
    log INFO "Service account token extraction: ENABLED (will run at end)"
  else
    log INFO "Service account token extraction: DISABLED (use --include-sa-tokens to enable)"
  fi

  check_prerequisites
  phase1_discovery
  phase2_credentials
  phase3_rbac
  phase4_security_contexts
  phase5_network
  phase6_nutanix_components
  generate_summary
  generate_actionable_items

  # Run SA token extraction at the end (if enabled) so we have all other results even if it's slow
  phase7_sa_tokens

  log SUCCESS "Penetration testing suite complete!"
  log INFO "Results available in: $OUTPUT_DIR"
  log WARN "Review findings and remediate security issues"
}

# Run main function
main

